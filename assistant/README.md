# Telegraf Assistant

## Overview

The Telegraf Assistant is a tool that allows Telegraf users to modify plugin configurations through HTTP operations. Instantiated alongside the Telegraf Agent running on a local machine, the Assistant communicates with a remote cloud server via HTTP websockets, providing a given `INFLUX_TOKEN` environment variable as a header token for identification purposes. Any changes made to plugins are reflected in the stored configuration file (currently set as `updated_config.conf`, so as not to overwrite the original configuration file).

### The Assistant in Agent

![The Assistant in Agent](https://drive.google.com/uc?export=view&id=1m40wcRut_g0bEZRrK_7WFPmtuUJFUo-e)

The assistant currently provides the functionality to start a plugin, stop a plugin, get a plugin’s configuration, update a plugin’s configuration, get a plugin’s default configuration values, get a plugin’s expected configuration types (eg: expected type for each filed), list all available plugins, and list all running plugins.

When started, a plugin is assigned a unique identifier. All plugins, after instantiation, must be referenced by their assigned identifiers through this API.

### Typical User Flow

![User Flow](https://drive.google.com/uc?export=view&id=1m39kXDYShez144eQ3UE9Hgt8FZ_1W1wa)

This project aims to take the hassle out of setting up Telegraf, allowing users to directly edit their configuration files through an easy to use web dashboard rather than editing raw TOML files.

## Setup

Set the `INFLUX_TOKEN` environment variable to your token obtained from the InfluxDB Dashboard. To do this, sign in to InfluxDB Cloud and navigate to Data > Tokens. Click or create the desired token and set the environment variable. Once the cloud server interface has been implemented, the token should be given the appropriate permissions -- this token will be sent as an authorization token in the HTTP header of each request.
You may wish to add the token to your `.bash_profile` or `.bashrc` to set the environment variable on terminal startup.
Currently, the default Assistant configuration connects to `localhost:8080/assistant`. This is the endpoint for the example server in the `mock_server` branch. Eventually, the `startAssistant()` function in `telegraf.go` should be modified to set the correct configuration host and path in the AssistantConfig struct, i.e. the InfluxDB Cloud endpoint.

## Plugin API

- Request/response headers include a Telegraf identifying token generated by the dashboard to differentiate between multiple instances (set by environment variable)
- Each request is a CRUD operation on a single plugin (except `GET_ALL_PLUGINS` and `GET_RUNNING_PLUGINS`), and is assigned a uuid, which links the request to its response.
- In the following table, id refers to the individual plugin id, and uuid refers to the id of the operation request.
- This implementation of Telegraf recognizes plugins by id, not name. When users run this version, the Assistant will assign IDs to the plugins automatically when reading in the user’s configuration file on startup.

### Start Plugin

Adds a new plugin with specified config

``` json
// REQUEST PAYLOAD
{
 "operation": "ADD_PLUGIN",
 "plugin": {
   "name": "cpu",
   "type": "input",
   "config": "<config struct here>"
 },
 "uuid": "213894y123..."
}
```

``` json
// RESPONSE
{
  "status": "SUCCESS",
  "data": { "id": "x14t-54..." },
  "uuid": "213894y123..."
}
```

### Get Plugin Config

Returns current configuration for the specified plugin

``` json
// REQUEST PAYLOAD
{
 "operation":"GET_PLUGIN",
 "plugin": {
   "id": "x14t-54...",
   "type": "input",
 },
 "uuid": "213895x123..."
}
```

``` json
// RESPONSE
{
  "status": "SUCCESS",
  "data": {
    "plugin": {
      "name": "cpu",
      "config": "<config struct here>",
      "id": "x14t-54..."
    }
  },
  "uuid": "213895x123..."
}
```

### Get Schema

Returns default configuration for the specified plugin, and a map of its field names to field types.

**Goal:** Allow the frontend to dynamically create field options based on the expected input type

``` json
// REQUEST PAYLOAD
{
 "operation":"GET_SCHEMA",
 "plugin": {
   "name": "cpu",
   "type": "input",
 },
 "uuid": "213895x123..."
}
```

``` json
// RESPONSE
{
  "status": "SUCCESS",
  "data": {
    "plugin": {
      "name": "cpu",
      "config": "<config struct here>",
      "id": "x14t-54..."
    }
  },
  "uuid": "213895x123..."
}
```

### Update Plugin

Update configuration for the specified fields.
On error, return current config as well as status.

``` json
// REQUEST PAYLOAD
{
 "operation": "UPDATE_PLUGIN",
 "plugin": {
   "id": "x14t-54...",
   "type": "input",
   "config": "<changed values struct here>"
 },
 "uuid": "213894y123..."
}
```

``` json
// RESPONSE
{
  "status": "success",
  "data": {
    "plugin": {
      "id": "x14t-54...",
      "name": "cpu",
      "config": "<updated config struct here>"
    }
  },
  "uuid": "213894y123..."
}
```

### Stop Plugin

Remove the plugin from config

``` json
// REQUEST PAYLOAD
{
 "operation": "DELETE_PLUGIN",
 "plugin": {
   "id": "x14t-54...",
   "type": "input",
 }  
 "uuid": "213894y123..."
}
```

``` json
// RESPONSE
{
  "status": "SUCCESS",
  "data": "plugin x14t-5… removed",
  "uuid": "213894y123..."
}
```

### Get All Plugins

Returns all plugins available to the Telegraf instance

``` json
// REQUEST PAYLOAD
{
  "operation": "GET_ALL_PLUGINS",
  "uuid": "213894y123..."
}
```

``` json
// RESPONSE
{
  "status": "SUCCESS",
  "data": ["cpu", "mem", "etc..."],
  "uuid": "213894y123..."
}
```

### Get Running Plugins

Returns all plugins currently running

``` json
// REQUEST PAYLOAD
{
  "operation": "GET_RUNNING_PLUGINS",
  "uuid": "213894y123..."
}
```

``` json
// RESPONSE
{
  "status": "SUCCESS",
  "data": {
  "inputs": [{"name": "iplugin", "id": "f8265a7c-567b-11eb-9d95-acbc32d39a19"}],
  "outputs": [{"name": "oplugin", "id": "f82658ba-567b-11eb-9d95-acbc32d39a19"}]
   },
  "uuid": "213894y123..."
}
```

### Unsuccessful request

On error, return failure with error message

``` json
// REQUEST PAYLOAD
{
  "operation": "UNSUPPORTED",
  "uuid": "213894y123..."
}
```

``` json
// RESPONSE
{
  "status": "FAILURE",
  "data": "<error details>",
  "uuid": "213894y123..."
}
```

## Persistent Changes

To ensure persistence, any changes that a user makes while Telegraf is running (adding or updating a plugin) will also be saved to a configuration file, currently defined as updated_config.conf so as to not overwrite the user’s original file.

Given updated configuration settings for a particular plugin, the assistant will trigger a traversal of the configuration AST Table (Syntax Tree) by reading in the configuration file and update the key-value pairs for the given plugin, then re-serialize to the configuration file.

Examples: When the user wants to remove a plugin, the assistant will simply not serialize that node when writing back to the configuration file. When the user wants to update a plugin, the assistant will write the new config values to the file.

### Workflow for Saving Changes

![Saving Changes](https://drive.google.com/uc?export=view&id=1wfyDbfjnP_McxCBj1oVDNIO0i4s0hCqE)

## Testing Environment

### Running Telegraf Assistant locally

On the mock_server branch of Codebase's forked repository [[link](https://github.com/codebase-berkeley/telegraf/tree/mock_server)], we have provided an example cloud server that can be used to test the assistant functionality. Before starting the Telegraf agent, open another terminal window and run:

``` bash
go run mock_server.go
```

Once Telegraf Assistant has connected to the mock server, you can test the 7 operations using either the command line prompt or access the web interface at `localhost:8080/`. In addition, it may be helpful to connect to the Data Explorer to visually verify that operations are executed correctly.

### Test Files

The tests for the assistant are in `assistant/assistant_test.go`
The tests for the config are in `config/config_test.go`

### Testing the service locally

To run all our unit tests on the Assistant, run `go test` in the `assistant/` directory and `go test` in the `config/` directory.

### Possible Improvements

- Persisting user-added comments when updating the TOML file
- Update a plugin without writing the plugin’s id to the TOML file to serve as an identifier
- Adding the same API for aggregators, processors, etc., as these currently only work for input and output plugins.
